#!/bin/bash
# FinClaude ç»Ÿä¸€å…¥å£å‘½ä»¤
# é‡‘èçº§ Claude Code å·¥å…·é“¾æ•´åˆ

FINCLAUDE_VERSION="1.0.0"

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    cat << 'HELP'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  FinClaude - é‡‘èçº§ Claude Code ç»Ÿä¸€å…¥å£                   â•‘
â•‘  ç‰ˆæœ¬: 1.0.0                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”¨æ³•:
  fin <command> [options]

å‘½ä»¤:
  plan <description>    è§„åˆ’é˜¶æ®µï¼šæŠ€æœ¯è°ƒç ” + æ¶æ„è®¾è®¡
  dev <description>     å¼€å‘é˜¶æ®µï¼šTDD å¼ºåˆ¶å¼€å‘
  review                ä»£ç å®¡æŸ¥ï¼šç®€åŒ– + å®¡æŸ¥
  notify <message>      æ‰‹åŠ¨è§¦å‘é£ä¹¦é€šçŸ¥
  status                æ˜¾ç¤ºå½“å‰çŠ¶æ€
  doctor                è¯Šæ–­ç¯å¢ƒé…ç½®
  help                  æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  version               æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯

ç¤ºä¾‹:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  fin plan "æ”¯ä»˜ç½‘å…³é‡æ„æ–¹æ¡ˆ"                            â”‚
  â”‚  fin dev "å®ç°è½¬è´¦åŠŸèƒ½"                                 â”‚
  â”‚  fin review                                            â”‚
  â”‚  fin notify "è‡ªå®šä¹‰æ¶ˆæ¯"                                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¯å¢ƒå˜é‡:
  FINCLAUDE_HOME        FinClaude å®‰è£…è·¯å¾„ (é»˜è®¤: ~/finclaude)
  FEISHU_WEBHOOK_URL    é£ä¹¦æœºå™¨äºº Webhook URL
  COVERAGE_THRESHOLD    æµ‹è¯•è¦†ç›–ç‡é˜ˆå€¼ (é»˜è®¤: 80)

æ›´å¤šä¿¡æ¯: https://github.com/zzpwestlife/finclaude
HELP
}

# è§„åˆ’é˜¶æ®µå‘½ä»¤
cmd_plan() {
    local description="$1"
    if [ -z "$description" ]; then
        echo "âŒ é”™è¯¯: è¯·æä¾›è§„åˆ’æè¿°"
        echo ""
        echo "ç”¨æ³•: fin plan <description>"
        echo "ç¤ºä¾‹: fin plan \"æ”¯ä»˜ç½‘å…³é‡æ„æ–¹æ¡ˆ\""
        exit 1
    fi
    
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ğŸ¯ FinClaude è§„åˆ’é˜¶æ®µ                                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ“‹ æè¿°: $description"
    echo "ğŸ”§ å·¥å…·: SuperClaude (/sc:research + /sc:architect)"
    echo ""
    echo "æ‰§è¡Œä¸­..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""
    
    claude -p "/sc:research '$description' && /sc:architect '$description'"
}

# å¼€å‘é˜¶æ®µå‘½ä»¤
cmd_dev() {
    local description="$1"
    if [ -z "$description" ]; then
        echo "âŒ é”™è¯¯: è¯·æä¾›å¼€å‘æè¿°"
        echo ""
        echo "ç”¨æ³•: fin dev <description>"
        echo "ç¤ºä¾‹: fin dev \"å®ç°è½¬è´¦åŠŸèƒ½\""
        exit 1
    fi
    
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ğŸ’» FinClaude å¼€å‘é˜¶æ®µ                                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ“‹ æè¿°: $description"
    
    # æ£€æŸ¥ Superpowers æ˜¯å¦å®‰è£…
    if claude -p "/superpowers:write-plan --help" >/dev/null 2>&1; then
        echo "ğŸ”§ å·¥å…·: Superpowers (TDD å¼ºåˆ¶: RED â†’ GREEN â†’ REFACTOR)"
        echo ""
        echo "æ‰§è¡Œä¸­..."
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo ""
        claude -p "/superpowers:write-plan '$description' && /superpowers:execute-plan"
    else
        echo "ğŸ”§ å·¥å…·: SuperClaude (/sc:implement)"
        echo "âš ï¸  æç¤º: å®‰è£… Superpowers å¯å¯ç”¨å¼ºåˆ¶ TDD æ¨¡å¼"
        echo ""
        echo "æ‰§è¡Œä¸­..."
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo ""
        claude -p "/sc:implement '$description'"
    fi
}

# ä»£ç å®¡æŸ¥å‘½ä»¤
cmd_review() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ğŸ” FinClaude ä»£ç å®¡æŸ¥                                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # è¿è¡Œ code-simplifier
    echo "1ï¸âƒ£  ä»£ç ç®€åŒ–..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    if npx code-simplifier 2>/dev/null; then
        echo ""
        echo "âœ… ä»£ç ç®€åŒ–å®Œæˆ"
    else
        echo ""
        echo "âš ï¸  code-simplifier æœªå®‰è£…æˆ–è¿è¡Œå¤±è´¥"
        echo "   å®‰è£…å‘½ä»¤: /plugin install code-simplifier"
    fi
    
    echo ""
    echo "2ï¸âƒ£  SuperClaude ä»£ç å®¡æŸ¥..."
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""
    claude -p "/sc:review"
}

# é€šçŸ¥å‘½ä»¤
cmd_notify() {
    local message="$1"
    if [ -z "$message" ]; then
        message="FinClaude ä»»åŠ¡å®Œæˆ"
    fi
    
    echo ""
    echo "ğŸ“± å‘é€é€šçŸ¥: $message"
    echo ""
    
    if [ -f ~/claude-code-notification/notify-system.js ]; then
        node ~/claude-code-notification/notify-system.js --message "$message"
    else
        echo "âŒ é€šçŸ¥ç³»ç»Ÿæœªå®‰è£…"
        echo "   å®‰è£…å‘½ä»¤: git clone https://github.com/zzpwestlife/claude-code-notification.git ~/claude-code-notification"
        exit 1
    fi
}

# çŠ¶æ€å‘½ä»¤
cmd_status() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ğŸ“Š FinClaude çŠ¶æ€                                         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    echo "ğŸ“ è·¯å¾„ä¿¡æ¯:"
    echo "   å®‰è£…è·¯å¾„: ${FINCLAUDE_HOME:-~/finclaude}"
    echo "   é€šçŸ¥ç³»ç»Ÿ: ~/claude-code-notification"
    echo ""
    
    echo "âœ… ç»„ä»¶çŠ¶æ€:"
    
    # æ£€æŸ¥å„ç»„ä»¶
    if command -v ccstatusline >/dev/null 2>&1; then
        echo "   âœ… ccstatusline ($(ccstatusline --version 2>/dev/null || echo 'å·²å®‰è£…'))"
    else
        echo "   âŒ ccstatusline (npm install -g ccstatusline)"
    fi
    
    if command -v superclaude >/dev/null 2>&1; then
        echo "   âœ… SuperClaude ($(superclaude --version 2>/dev/null || echo 'å·²å®‰è£…'))"
    else
        echo "   âš ï¸  SuperClaude (pipx install superclaude)"
    fi
    
    if command -v claude >/dev/null 2>&1; then
        echo "   âœ… Claude Code (å·²å®‰è£…)"
    else
        echo "   âŒ Claude Code (npm install -g @anthropic-ai/claude-code)"
    fi
    
    if [ -f ~/claude-code-notification/notify-system.js ]; then
        echo "   âœ… é€šçŸ¥ç³»ç»Ÿ (å·²å®‰è£…)"
    else
        echo "   âŒ é€šçŸ¥ç³»ç»Ÿ (æœªå®‰è£…)"
    fi
    
    echo ""
    echo "ğŸ“„ é…ç½®æ–‡ä»¶:"
    [ -f ~/.claude/settings.json ] && echo "   âœ… ~/.claude/settings.json" || echo "   âŒ ~/.claude/settings.json"
    [ -f ~/.finclaude/.env ] && echo "   âœ… ~/.finclaude/.env" || echo "   âŒ ~/.finclaude/.env"
    
    if [ -f ~/.finclaude/.env ]; then
        if grep -q "FEISHU_WEBHOOK_URL" ~/.finclaude/.env 2>/dev/null; then
            echo "   âœ… é£ä¹¦ Webhook (å·²é…ç½®)"
        else
            echo "   âš ï¸  é£ä¹¦ Webhook (æœªé…ç½®)"
        fi
    fi
    
    echo ""
}

# è¯Šæ–­å‘½ä»¤
cmd_doctor() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  ğŸ”§ FinClaude ç¯å¢ƒè¯Šæ–­                                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    local issues=0
    
    # æ£€æŸ¥ Node.js
    echo "ğŸ“¦ è¿è¡Œæ—¶ç¯å¢ƒ:"
    if command -v node >/dev/null 2>&1; then
        NODE_VERSION=$(node --version)
        NODE_MAJOR=$(echo $NODE_VERSION | cut -d'v' -f2 | cut -d'.' -f1)
        if [ "$NODE_MAJOR" -ge 18 ]; then
            echo "   âœ… Node.js: $NODE_VERSION"
        else
            echo "   âš ï¸  Node.js: $NODE_VERSION (å»ºè®® >= 18)"
            ((issues++))
        fi
    else
        echo "   âŒ Node.js: æœªå®‰è£…"
        echo "      å®‰è£…: https://nodejs.org/"
        ((issues++))
    fi
    
    # æ£€æŸ¥ Claude Code
    echo ""
    echo "ğŸ¤– Claude Code:"
    if command -v claude >/dev/null 2>&1; then
        echo "   âœ… å·²å®‰è£…"
    else
        echo "   âŒ æœªå®‰è£…"
        echo "      å®‰è£…: npm install -g @anthropic-ai/claude-code"
        ((issues++))
    fi
    
    # æ£€æŸ¥ ccstatusline
    echo ""
    echo "ğŸ“Š çŠ¶æ€ç›‘æ§:"
    if command -v ccstatusline >/dev/null 2>&1; then
        echo "   âœ… ccstatusline å·²å®‰è£…"
    else
        echo "   âŒ ccstatusline æœªå®‰è£…"
        echo "      å®‰è£…: npm install -g ccstatusline"
        ((issues++))
    fi
    
    # æ£€æŸ¥é€šçŸ¥ç³»ç»Ÿ
    echo ""
    echo "ğŸ“± é€šçŸ¥ç³»ç»Ÿ:"
    if [ -f ~/claude-code-notification/notify-system.js ]; then
        echo "   âœ… å·²å®‰è£…"
        
        # æ£€æŸ¥ .env
        if [ -f ~/claude-code-notification/.env ]; then
            if grep -q "FEISHU_WEBHOOK_URL" ~/claude-code-notification/.env 2>/dev/null; then
                echo "   âœ… é£ä¹¦é…ç½®: å·²é…ç½®"
            else
                echo "   âš ï¸  é£ä¹¦é…ç½®: æœªé…ç½® Webhook URL"
                ((issues++))
            fi
        else
            echo "   âš ï¸  é£ä¹¦é…ç½®: æœªåˆ›å»º .env æ–‡ä»¶"
            ((issues++))
        fi
    else
        echo "   âŒ æœªå®‰è£…"
        echo "      å®‰è£…: git clone https://github.com/zzpwestlife/claude-code-notification.git ~/claude-code-notification"
        ((issues++))
    fi
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    echo ""
    echo "âš™ï¸  é…ç½®æ–‡ä»¶:"
    if [ -f ~/.claude/settings.json ]; then
        echo "   âœ… ~/.claude/settings.json"
    else
        echo "   âŒ ~/.claude/settings.json"
        ((issues++))
    fi
    
    if [ -f ~/.finclaude/.env ]; then
        echo "   âœ… ~/.finclaude/.env"
    else
        echo "   âš ï¸  ~/.finclaude/.env (å¯é€‰)"
    fi
    
    # æ€»ç»“
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    if [ $issues -eq 0 ]; then
        echo "ğŸ‰ ç¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼FinClaude å·²å°±ç»ª"
    else
        echo "âš ï¸  å‘ç° $issues ä¸ªé—®é¢˜ï¼Œè¯·æ ¹æ®æç¤ºä¿®å¤"
        echo ""
        echo "å¿«é€Ÿä¿®å¤:"
        echo "   è¿è¡Œ ./install.sh é‡æ–°å®‰è£…"
    fi
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

# ä¸»å…¥å£
case "${1:-}" in
    plan)
        shift
        cmd_plan "$@"
        ;;
    dev)
        shift
        cmd_dev "$@"
        ;;
    review)
        cmd_review
        ;;
    notify)
        shift
        cmd_notify "$@"
        ;;
    status)
        cmd_status
        ;;
    doctor)
        cmd_doctor
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        echo "FinClaude v$FINCLAUDE_VERSION"
        ;;
    "")
        show_help
        ;;
    *)
        echo "âŒ é”™è¯¯: æœªçŸ¥å‘½ä»¤ '${1:-}'"
        echo ""
        show_help
        exit 1
        ;;
esac
